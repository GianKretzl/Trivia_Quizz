<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pergunta - {{ tema }} - Eureka do Padre</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pergunta.css') }}">
</head>
<body>
    <div class="pergunta-container">
        <!-- Cabe√ßalho com tema -->
        <div class="tema-header">
            <h1 style="margin:0;">{{ tema }}</h1>
        </div>

        <!-- Pergunta principal -->
        <div class="pergunta-box">
            <div class="pergunta-icone">?</div>
            <div class="pergunta-texto">{{ questao.enunciado }}</div>
        </div>

        <!-- Alternativas -->
        <div class="alternativas-grid">
            {% for alternativa in alternativas %}
            <div class="alternativa" data-opcao="{{ loop.index0 }}">
                <div class="alternativa-letra">{{ ['A', 'B', 'C', 'D'][loop.index0] }}</div>
                <div class="alternativa-texto">{{ alternativa }}</div>
            </div>
            {% endfor %}
        </div>

        <!-- Bot√µes de a√ß√£o -->
        <div class="acoes">
            <button id="btnRevelarResposta" class="btn-revelar">REVELAR RESPOSTA</button>
            <a href="/roleta" class="btn-voltar-roleta">
                <span class="btn-icon">üîô</span>
                <span class="btn-text">VOLTAR PARA A ROLETA</span>
            </a>
        </div>

        <!-- Se√ß√£o de equipes (inicialmente oculta) -->
        <div id="secaoEquipes" class="secao-equipes" style="display: none;">
            <div class="equipes-header">
                <div class="header-icon">üéØ</div>
                <h2>Quais equipes acertaram?</h2>
                <div class="equipes-subtitle">
                    <span class="subtitle-text">Clique nas equipes que deram a resposta correta</span>
                    <div class="equipes-counter">
                        <span id="equipesCounter">0</span> de {{ equipes|length }} equipes selecionadas
                    </div>
                </div>
            </div>
            
            <!-- Bot√µes de sele√ß√£o r√°pida -->
            <div class="selecao-rapida">
                <button id="btnSelecionarTodas" class="btn-selecao-rapida">
                    <span class="btn-icon">‚òëÔ∏è</span>
                    <span>Selecionar Todas</span>
                </button>
                <button id="btnLimparSelecao" class="btn-selecao-rapida">
                    <span class="btn-icon">‚ùå</span>
                    <span>Limpar Sele√ß√£o</span>
                </button>
            </div>
            
            <div class="equipes-grid">
                {% for equipe in equipes %}
                <div class="equipe-card" data-equipe-id="{{ equipe.id }}" data-equipe-nome="{{ equipe.nome }}">
                    <div class="equipe-card-inner">
                        <div class="equipe-nome">{{ equipe.nome }}</div>
                        <div class="equipe-status">
                            <div class="status-icon">‚ùå</div>
                            <div class="status-text">N√£o selecionada</div>
                        </div>
                        <div class="equipe-points">
                            <span class="points-value">+1</span>
                            <span class="points-label">pontos</span>
                        </div>
                    </div>
                    <div class="equipe-glow"></div>
                    <div class="selection-indicator"></div>
                    <input type="checkbox" id="equipe_{{ equipe.id }}" value="{{ equipe.id }}" style="display: none;">
                </div>
                {% endfor %}
            </div>
            
            <div class="acoes-finais">
                <div class="resumo-selecao" id="resumoSelecao" style="display: none;">
                    <div class="resumo-icon">üìä</div>
                    <div class="resumo-texto">
                        <strong id="resumoEquipes"></strong> receber√£o pontos
                    </div>
                </div>
                
                <button id="btnConfirmarVoltar" class="btn-confirmar-voltar" disabled>
                    <span class="btn-icon">‚úÖ</span>
                    <span class="btn-text">CONFIRMAR E VOLTAR √Ä ROLETA</span>
                </button>
                
                <button id="btnVoltarSemConfirmar" class="btn-voltar-sem-confirmar">
                    <span class="btn-icon">üîô</span>
                    <span class="btn-text">TODOS N√ÉO ACERTARAM!</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        const questaoId = parseInt('{{ questao.id }}');
        const respostaCorreta = parseInt('{{ questao.resposta_correta }}');

        document.getElementById('btnRevelarResposta').addEventListener('click', function() {
            // Destacar resposta correta
            const alternativas = document.querySelectorAll('.alternativa');
            alternativas.forEach(alt => {
                const opcao = parseInt(alt.getAttribute('data-opcao'));
                if (opcao === respostaCorreta) {
                    alt.classList.add('correta');
                } else {
                    alt.classList.add('incorreta');
                }
            });

            // Mostrar se√ß√£o de equipes
            document.getElementById('secaoEquipes').style.display = 'block';
            this.style.display = 'none';
            
            // Configurar interatividade dos cards das equipes
            setupEquipeCards();
        });

        function setupEquipeCards() {
            const equipeCards = document.querySelectorAll('.equipe-card');
            
            equipeCards.forEach(card => {
                card.addEventListener('click', function() {
                    toggleEquipe(this);
                });
            });
            
            // Configurar bot√µes de sele√ß√£o r√°pida
            document.getElementById('btnSelecionarTodas').addEventListener('click', function() {
                const equipeCards = document.querySelectorAll('.equipe-card');
                equipeCards.forEach(card => {
                    if (!card.classList.contains('selected')) {
                        toggleEquipe(card, true);
                    }
                });
            });
            
            document.getElementById('btnLimparSelecao').addEventListener('click', function() {
                const equipeCards = document.querySelectorAll('.equipe-card.selected');
                equipeCards.forEach(card => {
                    toggleEquipe(card, false);
                });
            });
            
            // Configurar bot√£o de voltar sem confirmar (todas erraram)
            document.getElementById('btnVoltarSemConfirmar').addEventListener('click', function() {
                if (confirm('Tem certeza que todas as equipes erraram a pergunta?')) {
                    console.log('DEBUG: Registrando rodada onde todas as equipes erraram');
                    
                    // Enviar dados indicando que nenhuma equipe acertou (array vazio)
                    fetch('/processar_respostas', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            questao_id: questaoId,
                            equipes_acertos: [] // Array vazio = ningu√©m acertou
                        })
                    })
                    .then(response => {
                        console.log('DEBUG: Response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('DEBUG: Response data:', data);
                        if (data.sucesso) {
                            // Voltar √† roleta ap√≥s registrar todas como erro
                            window.location.href = '/roleta';
                        } else {
                            alert('Erro ao registrar respostas: ' + (data.erro || 'Erro desconhecido'));
                        }
                    })
                    .catch(error => {
                        console.error('ERRO no fetch:', error);
                        alert('Erro ao processar respostas: ' + error.message);
                    });
                }
            });
        }
        
        function toggleEquipe(card, forceState = null) {
            const equipeId = card.getAttribute('data-equipe-id');
            const equipeNome = card.getAttribute('data-equipe-nome');
            const checkbox = document.getElementById(`equipe_${equipeId}`);
            const statusIcon = card.querySelector('.status-icon');
            const statusText = card.querySelector('.status-text');
            const isSelected = forceState !== null ? !forceState : checkbox.checked;
            
            if (isSelected) {
                // Desselecionar
                checkbox.checked = false;
                card.classList.remove('selected');
                statusIcon.textContent = '‚ùå';
                statusText.textContent = 'N√£o selecionada';
                
                // Anima√ß√£o de desele√ß√£o
                card.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    card.style.transform = '';
                }, 150);
            } else {
                // Selecionar
                checkbox.checked = true;
                card.classList.add('selected');
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = 'Acertou!';
                
                // Anima√ß√£o de sele√ß√£o
                card.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    card.style.transform = '';
                }, 150);
                
                // Efeito de confete
                createConfetti(card);
                
                // Som de sucesso (se dispon√≠vel)
                playSuccessSound();
            }
            
            updateCounter();
            updateConfirmButton();
            updateResumo();
        }
        
        function updateCounter() {
            const selectedCount = document.querySelectorAll('.equipe-card.selected').length;
            const totalCount = document.querySelectorAll('.equipe-card').length;
            document.getElementById('equipesCounter').textContent = selectedCount;
        }
        
        function updateConfirmButton() {
            const selectedCount = document.querySelectorAll('.equipe-card.selected').length;
            const btnConfirmar = document.getElementById('btnConfirmarVoltar');
            
            if (selectedCount > 0) {
                btnConfirmar.disabled = false;
                btnConfirmar.classList.remove('disabled');
                btnConfirmar.querySelector('.btn-text').textContent = `CONFIRMAR E VOLTAR √Ä ROLETA`;
            } else {
                btnConfirmar.disabled = true;
                btnConfirmar.classList.add('disabled');
                btnConfirmar.querySelector('.btn-text').textContent = 'SELECIONE PELO MENOS UMA EQUIPE';
            }
        }
        
        function updateResumo() {
            const selectedCards = document.querySelectorAll('.equipe-card.selected');
            const resumoDiv = document.getElementById('resumoSelecao');
            const resumoText = document.getElementById('resumoEquipes');
            
            if (selectedCards.length > 0) {
                const nomes = Array.from(selectedCards).map(card => 
                    card.getAttribute('data-equipe-nome')
                );
                
                if (nomes.length === 1) {
                    resumoText.textContent = nomes[0];
                } else if (nomes.length === 2) {
                    resumoText.textContent = `${nomes[0]} e ${nomes[1]}`;
                } else {
                    resumoText.textContent = `${nomes.length} equipes`;
                }
                
                resumoDiv.style.display = 'flex';
            } else {
                resumoDiv.style.display = 'none';
            }
        }
        
        function playSuccessSound() {
            // Criar um som de sucesso usando Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function createConfetti(element) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7'];
            
            for (let i = 0; i < 15; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.cssText = `
                    position: absolute;
                    width: 8px;
                    height: 8px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1000;
                `;
                
                const rect = element.getBoundingClientRect();
                confetti.style.left = (rect.left + rect.width / 2) + 'px';
                confetti.style.top = (rect.top + rect.height / 2) + 'px';
                
                document.body.appendChild(confetti);
                
                // Anima√ß√£o do confete
                const angle = (Math.PI * 2 * i) / 15;
                const distance = 50 + Math.random() * 50;
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance;
                
                confetti.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${x}px, ${y}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 800,
                    easing: 'ease-out'
                }).onfinish = () => confetti.remove();
            }
        }

        document.getElementById('btnConfirmarVoltar').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const equipesAcertos = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            console.log('DEBUG: questaoId =', questaoId);
            console.log('DEBUG: equipesAcertos =', equipesAcertos);
            console.log('DEBUG: Enviando dados:', { questao_id: questaoId, equipes_acertos: equipesAcertos });

            fetch('/processar_respostas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    questao_id: questaoId,
                    equipes_acertos: equipesAcertos
                })
            })
            .then(response => {
                console.log('DEBUG: Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('DEBUG: Response data:', data);
                if (data.sucesso) {
                    // Voltar diretamente √† roleta sem mensagem
                    window.location.href = '/roleta';
                } else {
                    alert('Erro ao registrar respostas: ' + (data.erro || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('ERRO no fetch:', error);
                alert('Erro ao processar respostas: ' + error.message);
            });
        });
    </script>
</body>
</html>
