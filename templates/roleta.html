<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta - Eureka do Padre</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/roleta.css') }}">
</head>
<body>
    <div class="roleta-layout">
        <!-- Placar √† esquerda -->
        <aside class="placar-col">
            <div class="placar-header">
                <h2>üèÜ Placar</h2>
                <div id="placar" class="placar-grid"></div>
                <div class="placar-botoes">
                    <a href="/relatorio" class="btn-relatorio">üìä Relat√≥rio</a>
                    <a href="/novo_jogo" class="btn-novo-jogo">üîÑ Novo Jogo</a>
                </div>
            </div>
        </aside>
        <!-- Box cinza central -->
        <main class="roleta-col">
            <div class="box-cinza-central">
               <div class="folha">
                    <div class="seta"></div>
                    <div class="roleta" id="roleta">
                        <div class="box1"></div>
                        <div class="box2"></div>
                        <div class="box3"></div>
                        <div class="box4"></div>
                        <div class="box5"></div>
                        <div class="box6"></div>
                        <div class="box7"></div>
                        <div class="box8"></div>

                        <div class="premio premio0" id="opt0">Portugu√™s</div>
                        <div class="premio premio1" id="opt1">Matem√°tica</div>
                        <div class="premio premio2" id="opt2">Geografia </div>
                        <div class="premio premio3" id="opt3">L√≠ngua Inglesa </div>
                        <div class="premio premio4" id="opt4">Ci√™ncias</div>
                        <div class="premio premio5" id="opt5">Hist√≥ria</div>
                        <div class="premio premio6" id="opt6">Educa√ß√£o F√≠sica</div>
                        <div class="premio premio7" id="opt7">Filosofia</div>
                        <div id="btnPlay" class="btnRoleta play" onclick="playOnClick()">GIRAR</div>
      
                    </div>
                </div>
            </div>
        </main>
        <!-- Tema sorteado √† direita -->
        <aside class="tema-col">
            <div class="tema-sorteado-box">
                <h2>Tema Sorteado</h2>
                <div id="tema-sorteado" class="tema-sorteado">Nenhum</div>
                <button id="btnIrPergunta" class="btn-primary" disabled>IR PARA PERGUNTA</button>
            </div>
        </aside>
    </div>
    <script>
    // Fun√ß√£o para atualizar o placar dinamicamente
    function atualizarPlacar(equipes) {
        const placarDiv = document.getElementById('placar');
        placarDiv.innerHTML = '';
        equipes.forEach(eq => {
            // Corrige nome da cor para classe CSS: min√∫sculo e espa√ßos/acentos para underline
            let corClasse = eq.cor.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/\s+/g, '_');
            const el = document.createElement('div');
            el.className = `equipe-placar cor-${corClasse}`;
            el.innerHTML = `<span class='equipe-nome'>${eq.nome}</span><span class='equipe-pontos'>${eq.pontos}</span>`;
            placarDiv.appendChild(el);
        });
    }
    

    let globalObjects;


            // Vari√°vel para guardar o tema sorteado da rodada
            let temaSorteadoRodada = null;

            function playOnClick() {
                globalObjects = {
                    btnPlay: document.getElementById("btnPlay"),
                    roleta: document.getElementById("roleta"),
                };
                globalObjects.timeInitial = new Date();
                // N√£o esconder o bot√£o GIRAR
                const randomRotation = Math.floor(Math.random() * 3600) + 360; // Rota√ß√£o aleat√≥ria entre 360 e 3960 graus
                globalObjects.roleta.style.transition = "transform 4s cubic-bezier(0.23, 1, 0.32, 1)"; // Transi√ß√£o suave
                globalObjects.roleta.style.transform = `rotate(${randomRotation}deg)`;

                // Ap√≥s o giro, identificar o tema sorteado
                setTimeout(() => {
                    // Extrair o valor da rota√ß√£o final da roleta
                    const transformValue = globalObjects.roleta.style.transform;
                    // Extrai o n√∫mero do rotate
                    const match = /rotate\(([-\d.]+)deg\)/.exec(transformValue);
                    let rotationDegrees = 0;
                    if (match) {
                        rotationDegrees = parseFloat(match[1]) % 360;
                        if (rotationDegrees < 0) rotationDegrees += 360;
                    }
                    
                    // Calcular qual se√ß√£o foi selecionada
                    // A seta aponta para o topo (0¬∞), ent√£o precisamos ajustar o c√°lculo
                    // Cada se√ß√£o tem 45¬∞ (360¬∞ / 8 se√ß√µes)
                    const sections = 8;
                    const sectionDegree = 360 / sections; // 45¬∞
                    
                    // Ajustar para a seta no topo - invertemos a rota√ß√£o e adicionamos offset
                    let adjustedRotation = (360 - rotationDegrees + (sectionDegree / 2)) % 360;
                    let winningSection = Math.floor(adjustedRotation / sectionDegree) % sections;
                    
                    console.log(`Rota√ß√£o: ${rotationDegrees}¬∞, Se√ß√£o vencedora: ${winningSection}`);
                    
                    // IDs dos temas: opt0, opt1, ..., opt7
                    const boxGanhador = document.getElementById("opt" + winningSection);
                    temaSorteadoRodada = boxGanhador ? boxGanhador.innerText : "";
                    
                    // Exibir no painel de tema sorteado
                    const temaSorteadoDiv = document.getElementById("tema-sorteado");
                    if (temaSorteadoDiv) {
                        temaSorteadoDiv.textContent = temaSorteadoRodada;
                        temaSorteadoDiv.classList.add("mostrar");
                    }
                    
                    // Habilitar bot√£o IR PARA PERGUNTA
                    const btnIrPergunta = document.getElementById("btnIrPergunta");
                    if (btnIrPergunta) {
                        btnIrPergunta.disabled = false;
                        btnIrPergunta.classList.remove("disabled");
                    }
                    // Aqui voc√™ pode salvar temaSorteadoRodada para o relat√≥rio
                }, 4100); // tempo do giro + leve atraso
            }

            // Adicionar evento de clique ao bot√£o IR PARA PERGUNTA
            document.addEventListener('DOMContentLoaded', function() {
                const btnIrPergunta = document.getElementById("btnIrPergunta");
                if (btnIrPergunta) {
                    btnIrPergunta.addEventListener('click', function() {
                        if (!this.disabled && temaSorteadoRodada) {
                            // Redirecionar para a p√°gina de pergunta com o tema sorteado
                            window.location.href = `/pergunta?tema=${encodeURIComponent(temaSorteadoRodada)}`;
                        }
                    });
                }
            });

            function stopOnClick() {

                globalObjects.btnStop.style.visibility = "hidden";

                // Extrair o valor da rota√ß√£o final da roleta

                const transformValue = globalObjects.roleta.style.transform;

                const rotationDegrees = parseInt(transformValue.replace(/[^0-9]/g, '')) % 360;

                // Calcular qual se√ß√£o foi selecionada

                const sections = 8; // N√∫mero de se√ß√µes

                const sectionDegree = 360 / sections;

                const winningSection = Math.floor(rotationDegrees / sectionDegree);

                const boxGanhador = document.getElementById("opt".concat(winningSection));

                document.getElementById("msgGanhador").innerHTML = "Parab√©ns! Voc√™ ganhou ".concat(boxGanhador.innerHTML);

                // Mostrar o bot√£o de play novamente

                globalObjects.btnPlay.style.visibility = "visible";

            }       

    // Carregar equipes reais do backend (GET)
    fetch('/api/estado_jogo')
        .then(response => response.json())
        .then(data => {
            if (data.equipes && data.equipes.length > 0) {
                atualizarPlacar(data.equipes);
            } else {
                // fallback: mostra exemplo
                atualizarPlacar([
                    {nome: 'Equipe Azul', cor: 'azul', pontos: 0},
                    {nome: 'Equipe Laranja', cor: 'laranja', pontos: 0}
                ]);
            }
        })
        .catch(() => {
            atualizarPlacar([
                {nome: 'Equipe Azul', cor: 'azul', pontos: 0},
                {nome: 'Equipe Laranja', cor: 'laranja', pontos: 0}
            ]);
        });

    </script>
