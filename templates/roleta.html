<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta - Eureka do Padre</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/roleta.css') }}">
</head>
<body>
    <div class="roleta-layout">
        <!-- Placar √† esquerda -->
        <aside class="placar-col">
            <div class="placar-header">
                <h2>üèÜ Placar</h2>
                <div id="placar" class="placar-grid"></div>
                <div class="placar-botoes">
                    <a href="/relatorio" class="btn-relatorio">üìä Relat√≥rio</a>
                    <a href="/novo_jogo" class="btn-novo-jogo">üîÑ Novo Jogo</a>
                </div>
            </div>
        </aside>
        <!-- Box cinza central -->
        <main class="roleta-col">
            <div class="box-cinza-central" style="width: 320px; height: 320px; background: #e0e0e0; border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #888;">
               <div class="folha">

                    <div class="seta"></div>

                    <div class="roleta" id="roleta">
                        <div class="box1"></div>
                        <div class="box2"></div>
                        <div class="box3"></div>
                        <div class="box4"></div>
                        <div class="box5"></div>
                        <div class="box6"></div>
                        <div class="box7"></div>
                        <div class="box8"></div>

                        <div class="premio premio1" id="opt1">100 reais</div>
                        <div class="premio premio2" id="opt0">110 reais</div>
                        <div class="premio premio3" id="opt7">115 reais</div>
                        <div class="premio premio4" id="opt6">120 reais</div>
                        <div class="premio premio5" id="opt5">125 reais</div>
                        <div class="premio premio6" id="opt4">130 reais</div>
                        <div class="premio premio7" id="opt3">140 reais</div>
                        <div class="premio premio8" id="opt2">150 reais</div>
                        <div id="btnPlay" class="btnRoleta play" onclick="playOnClick()">‚ñ∫</div>
                        <div id="btnStop" class="btnRoleta stop" onclick="stopOnClick()">‚ùö‚ùö</div>

                    </div>

                </div>
            </div>
        </main>
        <!-- Tema sorteado √† direita -->
        <aside class="tema-col">
            <div class="tema-sorteado-box">
                <h2>Tema Sorteado</h2>
                <div id="tema-sorteado" class="tema-sorteado">Nenhum</div>
                <button id="btnIrPergunta" class="btn-primary" disabled>IR PARA PERGUNTA</button>
            </div>
        </aside>
    </div>
    <script>
    // Fun√ß√£o para atualizar o placar dinamicamente
    function atualizarPlacar(equipes) {
        const placarDiv = document.getElementById('placar');
        placarDiv.innerHTML = '';
        equipes.forEach(eq => {
            // Corrige nome da cor para classe CSS: min√∫sculo e espa√ßos/acentos para underline
            let corClasse = eq.cor.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/\s+/g, '_');
            const el = document.createElement('div');
            el.className = `equipe-placar cor-${corClasse}`;
            el.innerHTML = `<span class='equipe-nome'>${eq.nome}</span><span class='equipe-pontos'>${eq.pontos}</span>`;
            placarDiv.appendChild(el);
        });
    }
    

    let globalObjects;

            function playOnClick() {

                globalObjects = {

                    btnPlay: document.getElementById("btnPlay"),

                    roleta: document.getElementById("roleta"),

                    btnStop: document.getElementById("btnStop"),

                };

                globalObjects.timeInitial = new Date();

                globalObjects.btnPlay.style.visibility = "hidden";

                globalObjects.btnStop.style.visibility = "visible";

                

                const randomRotation = Math.floor(Math.random() * 3600) + 360; // Rota√ß√£o aleat√≥ria entre 360 e 3960 graus

                globalObjects.roleta.style.transition = "transform 4s ease-out"; // Transi√ß√£o suave

                globalObjects.roleta.style.transform = `rotate(${randomRotation}deg)`;

            }

            function stopOnClick() {

                globalObjects.btnStop.style.visibility = "hidden";

                // Extrair o valor da rota√ß√£o final da roleta

                const transformValue = globalObjects.roleta.style.transform;

                const rotationDegrees = parseInt(transformValue.replace(/[^0-9]/g, '')) % 360;

                // Calcular qual se√ß√£o foi selecionada

                const sections = 8; // N√∫mero de se√ß√µes

                const sectionDegree = 360 / sections;

                const winningSection = Math.floor(rotationDegrees / sectionDegree);

                const boxGanhador = document.getElementById("opt".concat(winningSection));

                document.getElementById("msgGanhador").innerHTML = "Parab√©ns! Voc√™ ganhou ".concat(boxGanhador.innerHTML);

                // Mostrar o bot√£o de play novamente

                globalObjects.btnPlay.style.visibility = "visible";

            }       

    // Carregar equipes reais do backend (GET)
    fetch('/api/estado_jogo')
        .then(response => response.json())
        .then(data => {
            if (data.equipes && data.equipes.length > 0) {
                atualizarPlacar(data.equipes);
            } else {
                // fallback: mostra exemplo
                atualizarPlacar([
                    {nome: 'Equipe Azul', cor: 'azul', pontos: 0},
                    {nome: 'Equipe Laranja', cor: 'laranja', pontos: 0}
                ]);
            }
        })
        .catch(() => {
            atualizarPlacar([
                {nome: 'Equipe Azul', cor: 'azul', pontos: 0},
                {nome: 'Equipe Laranja', cor: 'laranja', pontos: 0}
            ]);
        });

    </script>
