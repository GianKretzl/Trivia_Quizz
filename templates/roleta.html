<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta - Eureka do Padre</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/roleta.css') }}">
</head>
<body>
    <div class="roleta-layout">
        <!-- Placar √† esquerda -->
        <aside class="placar-col">
            <div class="placar-header">
                <h2>üèÜ Placar</h2>
                <div id="placar" class="placar-grid"></div>
                <div class="placar-botoes">
                    <a href="/relatorio" class="btn-relatorio">üìä Relat√≥rio</a>
                    <a href="/novo_jogo" class="btn-novo-jogo">üîÑ Novo Jogo</a>
                </div>
            </div>
        </aside>
        <!-- Sorteio central com padre -->
        <main class="roleta-col">
            <div class="padre-container">
                <!-- Bal√£o de fala com sorteio -->
                <div class="speech-bubble">
                     <div class="slot-machine" id="slotMachine">
                            <div class="slot-reel-unico" id="reel-materias">
                                <div class="slot-content" id="slot-content">
                                    <!-- Ser√° preenchido dinamicamente pelo JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resultado final -->
                        <div class="resultado-sorteio" id="resultadoSorteio" style="display: none;">
                            <div class="icone-resultado" id="iconeResultado">üéØ</div>
                            <div class="texto-resultado" id="textoResultado">Clique para sortear!</div>
                        </div>
                </div>
                
                <!-- Padre Eureka -->
                <img src="{{ url_for('static', filename='img/sem_fundo_eureka-Photoroom.png') }}" alt="Padre Eureka" class="padre-img">
            </div>
            
            <!-- Bot√£o de sorteio abaixo da imagem -->
            <div class="botao-sorteio-container">
                <button id="btnPlay" class="btn-sortear" onclick="playOnClick()">
                    <span class="emoji-btn">üé≤</span>
                    <span class="texto-btn">SORTEAR</span>
                </button>
            </div>
        </main>
        <!-- Tema sorteado √† direita -->
        <aside class="tema-col">
            <div class="tema-sorteado-box">
                <h2>Tema Sorteado</h2>
                <div id="tema-sorteado" class="tema-sorteado">Nenhum</div>
                <button id="btnIrPergunta" class="btn-primary" disabled>IR PARA PERGUNTA</button>
            </div>
        </aside>
    </div>
    <script>
    // Fun√ß√£o para atualizar o placar dinamicamente
    function atualizarPlacar(equipes) {
        const placarDiv = document.getElementById('placar');
        const placarCol = document.querySelector('.placar-col');
        placarDiv.innerHTML = '';
        
        // Remover todas as classes primeiro
        placarDiv.classList.remove('muitas-equipes', 'super-compacto');
        placarCol.classList.remove('cinco-equipes');
        
        // Adicionar classes baseadas no n√∫mero de equipes
        if (equipes.length >= 6) {
            placarDiv.classList.add('muitas-equipes', 'super-compacto');
        } else if (equipes.length >= 4) {
            placarDiv.classList.add('muitas-equipes');
        }
        
        // Ajuste especial para 5 equipes - placar sobe
        if (equipes.length === 5) {
            placarCol.classList.add('cinco-equipes');
        }
        
        equipes.forEach(eq => {
            // Corrige nome da cor para classe CSS: min√∫sculo e espa√ßos/acentos para underline
            let corClasse = eq.cor.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/\s+/g, '_');
            const el = document.createElement('div');
            el.className = `equipe-placar cor-${corClasse}`;
            el.innerHTML = `
                <div class="equipe-info">
                    <span class='equipe-nome'>${eq.nome}</span>
                    <div class="equipe-controles">
                        <button class="btn-pontos btn-menos" onclick="ajustarPontos('${eq.nome}', -1)" title="Remover 1 ponto">-1</button>
                        <span class='equipe-pontos'>${eq.pontos}</span>
                        <button class="btn-pontos btn-mais" onclick="ajustarPontos('${eq.nome}', 1)" title="Adicionar 1 ponto">+1</button>
                    </div>
                </div>
            `;
            placarDiv.appendChild(el);
        });
    }
    
    // Fun√ß√£o para ajustar pontos das equipes
    async function ajustarPontos(nomeEquipe, pontos) {
        try {
            const response = await fetch('/api/ajustar_pontos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    equipe: nomeEquipe,
                    pontos: pontos
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.sucesso) {
                    // Recarregar placar imediatamente para mostrar a atualiza√ß√£o
                    carregarPlacar();
                    console.log(`Pontos ajustados: ${nomeEquipe} ${pontos > 0 ? '+' : ''}${pontos}`);
                } else {
                    console.error('Erro ao ajustar pontos:', result.erro);
                    alert('Erro ao ajustar pontos: ' + result.erro);
                }
            } else {
                console.error('Erro na requisi√ß√£o:', response.status);
                alert('Erro ao comunicar com o servidor');
            }
        } catch (error) {
            console.error('Erro ao ajustar pontos:', error);
            alert('Erro ao ajustar pontos');
        }
    }
    

    let globalObjects;


            // Vari√°vel para guardar o tema sorteado da rodada
            let temaSorteadoRodada = null;
            
            // Disciplinas dispon√≠veis - ser√° carregado dinamicamente baseado na turma
            let disciplinas = [];
            
            // Fun√ß√£o para obter disciplinas da turma ativa
            async function carregarDisciplinas() {
                try {
                    const response = await fetch('/api/estado_jogo');
                    const data = await response.json();
                    
                    if (data.turma_ativa) {
                        // Mapear disciplinas baseado na turma
                        const disciplinasPorTurma = {
                            'ensino_medio': [
                                { emoji: 'üìñ', nome: 'Portugu√™s' },
                                { emoji: 'üî¢', nome: 'Matem√°tica' },
                                { emoji: 'üåç', nome: 'Geografia' },
                                { emoji: 'üá∫üá∏', nome: 'L√≠ngua Inglesa' },
                                { emoji: 'üß¨', nome: 'Biologia' },
                                { emoji: 'üèõÔ∏è', nome: 'Hist√≥ria' },
                                { emoji: '‚öΩ', nome: 'Educa√ß√£o F√≠sica' },
                                { emoji: 'üß™', nome: 'Qu√≠mica' },
                                { emoji: '‚öõÔ∏è', nome: 'F√≠sica' },
                                { emoji: 'ü§î', nome: 'Filosofia' },
                                { emoji: 'üí∞', nome: 'Educa√ß√£o Financeira' }
                            ],
                            'default': [
                                { emoji: 'üìñ', nome: 'Portugu√™s' },
                                { emoji: 'üî¢', nome: 'Matem√°tica' },
                                { emoji: 'üåç', nome: 'Geografia' },
                                { emoji: 'üá∫üá∏', nome: 'L√≠ngua Inglesa' },
                                { emoji: 'üî¨', nome: 'Ci√™ncias' },
                                { emoji: 'üèõÔ∏è', nome: 'Hist√≥ria' },
                                { emoji: '‚öΩ', nome: 'Educa√ß√£o F√≠sica' }
                            ]
                        };
                        
                        disciplinas = disciplinasPorTurma[data.turma_ativa] || disciplinasPorTurma['default'];
                        console.log(`Disciplinas carregadas para ${data.turma_ativa}:`, disciplinas.map(d => d.nome));
                    } else {
                        // Fallback para fundamental
                        disciplinas = [
                            { emoji: 'üìñ', nome: 'Portugu√™s' },
                            { emoji: 'üî¢', nome: 'Matem√°tica' },
                            { emoji: 'üåç', nome: 'Geografia' },
                            { emoji: 'üá∫üá∏', nome: 'L√≠ngua Inglesa' },
                            { emoji: 'üî¨', nome: 'Ci√™ncias' },
                            { emoji: 'üèõÔ∏è', nome: 'Hist√≥ria' },
                            { emoji: '‚öΩ', nome: 'Educa√ß√£o F√≠sica' }
                        ];
                    }
                } catch (error) {
                    console.error('Erro ao carregar disciplinas:', error);
                    // Fallback para fundamental em caso de erro
                    disciplinas = [
                        { emoji: 'üìñ', nome: 'Portugu√™s' },
                        { emoji: 'üî¢', nome: 'Matem√°tica' },
                        { emoji: 'üåç', nome: 'Geografia' },
                        { emoji: 'üá∫üá∏', nome: 'L√≠ngua Inglesa' },
                        { emoji: 'üî¨', nome: 'Ci√™ncias' },
                        { emoji: 'üèõÔ∏è', nome: 'Hist√≥ria' },
                        { emoji: '‚öΩ', nome: 'Educa√ß√£o F√≠sica' }
                    ];
                }
            }

            // Fun√ß√£o para criar o slot com a disciplina sorteada no meio
            function criarSlotComDisciplinaSorteada(disciplinaSorteada) {
                const slotContent = document.getElementById('slot-content');
                slotContent.innerHTML = '';
                
                // Encontrar o √≠ndice da disciplina sorteada nas 7 disciplinas dispon√≠veis
                const indiceSorteada = disciplinas.findIndex(d => d.nome === disciplinaSorteada);
                
                // Criar EXATAMENTE 3 disciplinas com a sorteada no meio
                const disciplinasSlot = [];
                
                // Disciplina anterior (primeira posi√ß√£o)
                const indiceAnterior = (indiceSorteada - 1 + disciplinas.length) % disciplinas.length;
                disciplinasSlot.push(disciplinas[indiceAnterior]);
                
                // Disciplina sorteada (meio - segunda posi√ß√£o)
                disciplinasSlot.push(disciplinas[indiceSorteada]);
                
                // Disciplina posterior (terceira posi√ß√£o)
                const indicePosterior = (indiceSorteada + 1) % disciplinas.length;
                disciplinasSlot.push(disciplinas[indicePosterior]);
                
                console.log('Criando slot com 3 disciplinas:', disciplinasSlot.map(d => d.nome));
                
                // Criar os elementos HTML
                disciplinasSlot.forEach((disciplina, index) => {
                    const div = document.createElement('div');
                    div.className = 'slot-item';
                    div.textContent = disciplina.nome;
                    slotContent.appendChild(div);
                });
            }

            function playOnClick() {
                const btnPlay = document.getElementById("btnPlay");
                const slotMachine = document.getElementById("slotMachine");
                const resultadoSorteio = document.getElementById("resultadoSorteio");
                const reelMaterias = document.getElementById("reel-materias");
                const slotContent = document.getElementById("slot-content");
                
                // Desabilitar bot√£o durante o sorteio
                btnPlay.disabled = true;
                btnPlay.classList.add('sorteando');
                
                // Esconder resultado anterior
                resultadoSorteio.style.display = 'none';
                slotMachine.style.display = 'flex';
                
                // Sortear disciplina ANTES da anima√ß√£o (entre todas as 7 dispon√≠veis)
                const indiceAleatorio = Math.floor(Math.random() * disciplinas.length);
                const disciplinaSorteada = disciplinas[indiceAleatorio];
                temaSorteadoRodada = disciplinaSorteada.nome;
                
                console.log(`Sorteando entre ${disciplinas.length} disciplinas: ${disciplinaSorteada.nome}`);
                
                // Criar apenas 3 disciplinas para anima√ß√£o
                slotContent.innerHTML = '';
                for (let i = 0; i < 3; i++) {
                    const indiceRandomico = Math.floor(Math.random() * disciplinas.length);
                    const div = document.createElement('div');
                    div.className = 'slot-item';
                    div.textContent = disciplinas[indiceRandomico].nome;
                    slotContent.appendChild(div);
                }
                
                // Reset posi√ß√£o
                slotContent.style.transition = 'none';
                slotContent.style.transform = 'translateY(0)';
                
                // Pequeno delay para garantir que o reset foi aplicado
                setTimeout(() => {
                    // Iniciar anima√ß√£o r√°pida do ca√ßa-n√≠quel
                    reelMaterias.classList.add('girando');
                    
                    // Adicionar efeito de brilho durante a anima√ß√£o
                    const slotItems = document.querySelectorAll('.slot-item');
                    slotItems.forEach(item => item.classList.add('animando'));
                    
                    // Parar anima√ß√£o e mostrar resultado ap√≥s 2.5 segundos
                    setTimeout(() => {
                        // Parar anima√ß√£o
                        reelMaterias.classList.remove('girando');
                        
                        // Remover efeito de brilho
                        slotItems.forEach(item => item.classList.remove('animando'));
                        
                        // Criar slot final com a disciplina sorteada no meio
                        criarSlotComDisciplinaSorteada(disciplinaSorteada.nome);
                        
                        // Animar para mostrar resultado final (disciplina do meio)
                        setTimeout(() => {
                            // Destacar disciplina do meio (a sorteada)
                            const itemDoMeio = document.querySelector('.slot-item:nth-child(2)'); // Segundo item (meio de 3)
                            if (itemDoMeio) {
                                itemDoMeio.classList.add('sorteado');
                                
                                // Criar efeito de confete
                                criarConfete();
                            }
                            
                            // Exibir no painel de tema sorteado
                            const temaSorteadoDiv = document.getElementById("tema-sorteado");
                            if (temaSorteadoDiv) {
                                temaSorteadoDiv.textContent = temaSorteadoRodada;
                                temaSorteadoDiv.classList.add("mostrar");
                            }
                            
                            // Habilitar bot√£o IR PARA PERGUNTA
                            const btnIrPergunta = document.getElementById("btnIrPergunta");
                            if (btnIrPergunta) {
                                btnIrPergunta.disabled = false;
                                btnIrPergunta.classList.remove("disabled");
                            }
                            
                            // Reabilitar bot√£o de sortear
                            btnPlay.disabled = false;
                            btnPlay.classList.remove('sorteando');
                            btnPlay.classList.add('novamente');
                            btnPlay.querySelector('.texto-btn').innerHTML = 'NOVO<br>SORTEIO';
                            
                        }, 500); // Pequeno delay para mostrar o resultado
                        
                    }, 2500);
                    
                }, 50);
            }

            // Inicializar slot com disciplinas aleat√≥rias
            function inicializarSlot() {
                const disciplinaAleatoria = disciplinas[Math.floor(Math.random() * disciplinas.length)];
                criarSlotComDisciplinaSorteada(disciplinaAleatoria.nome);
            }

            // Fun√ß√£o para criar efeito de confete
            function criarConfete() {
                const speechBubble = document.querySelector('.speech-bubble');
                const container = document.createElement('div');
                container.className = 'confete-container';
                speechBubble.appendChild(container);

                // Criar 15 part√≠culas de confete
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => {
                        const confete = document.createElement('div');
                        confete.className = 'confete';
                        
                        // Posi√ß√£o inicial aleat√≥ria
                        confete.style.left = Math.random() * 300 + 'px';
                        confete.style.top = '-20px';
                        
                        // Cores aleat√≥rias
                        const cores = ['#FF6B35', '#FFD23F', '#06FFA5', '#118AB2', '#F7931E'];
                        confete.style.backgroundColor = cores[Math.floor(Math.random() * cores.length)];
                        
                        // Anima√ß√£o aleat√≥ria
                        const animacoes = ['confeteCair', 'confeteEsquerda', 'confeteDireita'];
                        const animacao = animacoes[Math.floor(Math.random() * animacoes.length)];
                        confete.style.animation = `${animacao} ${1.5 + Math.random()}s linear forwards`;
                        
                        container.appendChild(confete);
                        
                        // Remover confete ap√≥s anima√ß√£o
                        setTimeout(() => {
                            if (confete.parentNode) {
                                confete.parentNode.removeChild(confete);
                            }
                        }, 3000);
                    }, i * 100); // Delay entre cada part√≠cula
                }
                
                // Remover container ap√≥s 5 segundos
                setTimeout(() => {
                    if (container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                }, 5000);
            }

            // Adicionar evento de clique ao bot√£o IR PARA PERGUNTA
            document.addEventListener('DOMContentLoaded', async function() {
                // Carregar disciplinas primeiro
                await carregarDisciplinas();
                
                // Inicializar o slot com disciplinas
                inicializarSlot();
                
                const btnIrPergunta = document.getElementById("btnIrPergunta");
                if (btnIrPergunta) {
                    btnIrPergunta.addEventListener('click', function() {
                        if (!this.disabled && temaSorteadoRodada) {
                            // Redirecionar para a p√°gina de pergunta com o tema sorteado
                            window.location.href = `/pergunta?tema=${encodeURIComponent(temaSorteadoRodada)}`;
                        }
                    });
                }

                // Verificar se a p√°gina foi carregada vinda de uma pergunta
                // Se sim, recarregar o placar imediatamente
                if (document.referrer.includes('/pergunta')) {
                    console.log('Retornando da p√°gina de pergunta, atualizando placar...');
                    setTimeout(carregarPlacar, 100); // Pequeno atraso para garantir que a p√°gina carregou
                }
            });

            function stopOnClick() {

                globalObjects.btnStop.style.visibility = "hidden";

                // Extrair o valor da rota√ß√£o final da roleta

                const transformValue = globalObjects.roleta.style.transform;

                const rotationDegrees = parseInt(transformValue.replace(/[^0-9]/g, '')) % 360;

                // Calcular qual se√ß√£o foi selecionada

                const sections = 8; // N√∫mero de se√ß√µes

                const sectionDegree = 360 / sections;

                const winningSection = Math.floor(rotationDegrees / sectionDegree);

                const boxGanhador = document.getElementById("opt".concat(winningSection));

                document.getElementById("msgGanhador").innerHTML = "Parab√©ns! Voc√™ ganhou ".concat(boxGanhador.innerHTML);

                // Mostrar o bot√£o de play novamente

                globalObjects.btnPlay.style.visibility = "visible";

            }       

    // Carregar equipes reais do backend (GET)
    function carregarPlacar() {
        fetch('/api/estado_jogo')
            .then(response => response.json())
            .then(data => {
                if (data.equipes && data.equipes.length > 0) {
                    atualizarPlacar(data.equipes);
                    console.log('Placar atualizado:', data.equipes);
                } else {
                    // fallback: mostra exemplo
                    atualizarPlacar([
                        {nome: 'Equipe Azul', cor: 'azul', pontos: 0},
                        {nome: 'Equipe Laranja', cor: 'laranja', pontos: 0}
                    ]);
                }
            })
            .catch(error => {
                console.error('Erro ao carregar placar:', error);
                atualizarPlacar([
                    {nome: 'Equipe Azul', cor: 'azul', pontos: 0},
                    {nome: 'Equipe Laranja', cor: 'laranja', pontos: 0}
                ]);
            });
    }

    // Carregar placar ao inicializar a p√°gina
    carregarPlacar();

    // Recarregar placar a cada 5 segundos para manter atualizado
    setInterval(carregarPlacar, 5000);

    </script>
