<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta - Eureka do Padre</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/roleta.css') }}">
</head>
<body>
    <div class="roleta-layout">
        <!-- Placar √† esquerda -->
        <aside class="placar-col">
            <div class="placar-header">
                <h2>üèÜ Placar</h2>
                <div id="placar" class="placar-grid"></div>
                <div class="placar-botoes">
                    <a href="/relatorio" class="btn-relatorio">üìä Relat√≥rio</a>
                    <a href="/novo_jogo" class="btn-novo-jogo">üîÑ Novo Jogo</a>
                </div>
            </div>
        </aside>
        <!-- Sorteio central com padre -->
        <main class="roleta-col">
            <div class="padre-container">   
           
                 
                            
                <!-- Padre Eureka -->
                <img src="{{ url_for('static', filename='img/sem fundo eureka-Photoroom.png') }}" alt="Padre Eureka" class="padre-img">
            </div>
            
            <!-- Bot√£o de sorteio abaixo da imagem -->
            <div class="botao-sorteio-container">
                <button id="btnPlay" class="btn-sortear" onclick="playOnClick()">
                    <span class="emoji-btn">üé≤</span>
                    <span class="texto-btn">SORTEAR</span>
                </button>
            </div>
        </main>
        <!-- Tema sorteado √† direita -->
        <aside class="tema-col">
            <div class="tema-sorteado-box">
                <h2>Tema Sorteado</h2>
                <div id="tema-sorteado" class="tema-sorteado">Nenhum</div>
                <button id="btnIrPergunta" class="btn-primary" disabled>IR PARA PERGUNTA</button>
            </div>
        </aside>
    </div>
    <script>
    // Fun√ß√£o para atualizar o placar dinamicamente
    function atualizarPlacar(equipes) {
        const placarDiv = document.getElementById('placar');
        placarDiv.innerHTML = '';
        equipes.forEach(eq => {
            // Corrige nome da cor para classe CSS: min√∫sculo e espa√ßos/acentos para underline
            let corClasse = eq.cor.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/\s+/g, '_');
            const el = document.createElement('div');
            el.className = `equipe-placar cor-${corClasse}`;
            el.innerHTML = `<span class='equipe-nome'>${eq.nome}</span><span class='equipe-pontos'>${eq.pontos}</span>`;
            placarDiv.appendChild(el);
        });
    }
    

    let globalObjects;


            // Vari√°vel para guardar o tema sorteado da rodada
            let temaSorteadoRodada = null;
            
            // Disciplinas dispon√≠veis
            const disciplinas = [
                { emoji: 'üìñ', nome: 'Portugu√™s' },
                { emoji: 'üî¢', nome: 'Matem√°tica' },
                { emoji: 'üåç', nome: 'Geografia' },
                { emoji: 'üá∫üá∏', nome: 'L√≠ngua Inglesa' },
                { emoji: 'üî¨', nome: 'Ci√™ncias' },
                { emoji: 'üèõÔ∏è', nome: 'Hist√≥ria' },
                { emoji: '‚öΩ', nome: 'Educa√ß√£o F√≠sica' }
            ];

            function playOnClick() {
                const btnPlay = document.getElementById("btnPlay");
                const slotMachine = document.getElementById("slotMachine");
                const resultadoSorteio = document.getElementById("resultadoSorteio");
                const reelMaterias = document.getElementById("reel-materias");
                
                // Desabilitar bot√£o durante o sorteio
                btnPlay.disabled = true;
                btnPlay.classList.add('sorteando');
                
                // Esconder resultado anterior
                resultadoSorteio.style.display = 'none';
                slotMachine.style.display = 'flex';
                
                // Animar o reel √∫nico
                reelMaterias.style.animation = 'spin 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                
                // Sortear disciplina ap√≥s anima√ß√£o
                setTimeout(() => {
                    // Sortear uma disciplina aleat√≥ria
                    const indiceAleatorio = Math.floor(Math.random() * disciplinas.length);
                    const disciplinaSorteada = disciplinas[indiceAleatorio];
                    
                    temaSorteadoRodada = disciplinaSorteada.nome;
                    
                    // Mostrar resultado
                    slotMachine.style.display = 'none';
                    
                    const iconeResultado = document.getElementById("iconeResultado");
                    const textoResultado = document.getElementById("textoResultado");
                    
                    iconeResultado.textContent = disciplinaSorteada.emoji;
                    textoResultado.textContent = disciplinaSorteada.nome;
                    
                    resultadoSorteio.style.display = 'flex';
                    resultadoSorteio.classList.add('resultado-aparecer');
                    
                    // Exibir no painel de tema sorteado
                    const temaSorteadoDiv = document.getElementById("tema-sorteado");
                    if (temaSorteadoDiv) {
                        temaSorteadoDiv.textContent = temaSorteadoRodada;
                        temaSorteadoDiv.classList.add("mostrar");
                    }
                    
                    // Habilitar bot√£o IR PARA PERGUNTA
                    const btnIrPergunta = document.getElementById("btnIrPergunta");
                    if (btnIrPergunta) {
                        btnIrPergunta.disabled = false;
                        btnIrPergunta.classList.remove("disabled");
                    }
                    
                    // Reabilitar bot√£o de sortear
                    btnPlay.disabled = false;
                    btnPlay.classList.remove('sorteando');
                    btnPlay.querySelector('.texto-btn').textContent = 'SORTEAR NOVAMENTE';
                    
                    // Reset anima√ß√£o
                    reelMaterias.style.animation = '';
                    
                }, 2600); // Aguardar fim da anima√ß√£o
            }

            // Adicionar evento de clique ao bot√£o IR PARA PERGUNTA
            document.addEventListener('DOMContentLoaded', function() {
                const btnIrPergunta = document.getElementById("btnIrPergunta");
                if (btnIrPergunta) {
                    btnIrPergunta.addEventListener('click', function() {
                        if (!this.disabled && temaSorteadoRodada) {
                            // Redirecionar para a p√°gina de pergunta com o tema sorteado
                            window.location.href = `/pergunta?tema=${encodeURIComponent(temaSorteadoRodada)}`;
                        }
                    });
                }

                // Verificar se a p√°gina foi carregada vinda de uma pergunta
                // Se sim, recarregar o placar imediatamente
                if (document.referrer.includes('/pergunta')) {
                    console.log('Retornando da p√°gina de pergunta, atualizando placar...');
                    setTimeout(carregarPlacar, 100); // Pequeno atraso para garantir que a p√°gina carregou
                }
            });

            function stopOnClick() {

                globalObjects.btnStop.style.visibility = "hidden";

                // Extrair o valor da rota√ß√£o final da roleta

                const transformValue = globalObjects.roleta.style.transform;

                const rotationDegrees = parseInt(transformValue.replace(/[^0-9]/g, '')) % 360;

                // Calcular qual se√ß√£o foi selecionada

                const sections = 8; // N√∫mero de se√ß√µes

                const sectionDegree = 360 / sections;

                const winningSection = Math.floor(rotationDegrees / sectionDegree);

                const boxGanhador = document.getElementById("opt".concat(winningSection));

                document.getElementById("msgGanhador").innerHTML = "Parab√©ns! Voc√™ ganhou ".concat(boxGanhador.innerHTML);

                // Mostrar o bot√£o de play novamente

                globalObjects.btnPlay.style.visibility = "visible";

            }       

    // Carregar equipes reais do backend (GET)
    function carregarPlacar() {
        fetch('/api/estado_jogo')
            .then(response => response.json())
            .then(data => {
                if (data.equipes && data.equipes.length > 0) {
                    atualizarPlacar(data.equipes);
                    console.log('Placar atualizado:', data.equipes);
                } else {
                    // fallback: mostra exemplo
                    atualizarPlacar([
                        {nome: 'Equipe Azul', cor: 'azul', pontos: 0},
                        {nome: 'Equipe Laranja', cor: 'laranja', pontos: 0}
                    ]);
                }
            })
            .catch(error => {
                console.error('Erro ao carregar placar:', error);
                atualizarPlacar([
                    {nome: 'Equipe Azul', cor: 'azul', pontos: 0},
                    {nome: 'Equipe Laranja', cor: 'laranja', pontos: 0}
                ]);
            });
    }

    // Carregar placar ao inicializar a p√°gina
    carregarPlacar();

    // Recarregar placar a cada 5 segundos para manter atualizado
    setInterval(carregarPlacar, 5000);

    </script>
