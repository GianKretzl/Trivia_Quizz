<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta - Eureka do Padre</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/roleta.css') }}">
</head>
<body>
    <div class="roleta-layout">
        <!-- Placar √† esquerda -->
        <aside class="placar-col">
            <div class="placar-header">
                <h2>üèÜ Placar</h2>
                <div id="placar" class="placar-grid"></div>
                <div class="placar-botoes">
                        <a href="/relatorio" class="btn-relatorio">üìä Relat√≥rio</a>
                        <a href="/novo_jogo" class="btn-novo-jogo">üîÑ Novo Jogo</a>
                    </div>
                </div>
                <script>
                function atualizarPlacar(equipes) {
                    const placarDiv = document.getElementById('placar');
                    placarDiv.innerHTML = '';
                    equipes.forEach(eq => {
                        // Corrige nome da cor para classe CSS: min√∫sculo e espa√ßos/acentos para underline
                        let corClasse = eq.cor.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').replace(/\s+/g, '_');
                        const el = document.createElement('div');
                        el.className = `equipe-placar cor-${corClasse}`;
                        el.innerHTML = `<span class='equipe-nome'>${eq.nome}</span><span class='equipe-pontos'>${eq.pontos}</span>`;
                        placarDiv.appendChild(el);
                    });
                }
                </script>
        </aside>
        <!-- Roleta central -->
        <main class="roleta-col">
            <div class="folha">
                <div class="seta-roleta-externa">
                    <div class="seta"></div>
                </div>
                <div class="roleta" id="roleta">
                    <div class="box1"></div>
                    <div class="box2"></div>
                    <div class="box3"></div>
                    <div class="box4"></div>
                    <div class="box5"></div>
                    <div class="box6"></div>
                    <div class="box7"></div>
                    <div class="box8"></div>
                    <!-- Disciplinas -->
                    <div class="premio premio1" id="opt1">Matem√°tica</div>
                    <div class="premio premio2" id="opt0">Portugu√™s</div>
                    <div class="premio premio3" id="opt7">Hist√≥ria</div>
                    <div class="premio premio4" id="opt6">Geografia</div>
                    <div class="premio premio5" id="opt5">Ci√™ncias</div>
                    <div class="premio premio6" id="opt4">Ingl√™s</div>
                    <div class="premio premio7" id="opt3">Arte</div>
                    <div class="premio premio8" id="opt2">Educa√ß√£o F√≠sica</div>
                    <div id="btnGirar" class="btnRoleta play" onclick="girarRoleta()">GIRAR</div>
                </div>
            </div>
        </main>
        <!-- Tema sorteado √† direita -->
        <aside class="tema-col">
            <div class="tema-sorteado-box">
                <h2>Tema Sorteado</h2>
                <div id="tema-sorteado" class="tema-sorteado">Nenhum</div>
                <button id="btnIrPergunta" class="btn-primary" disabled>IR PARA PERGUNTA</button>
            </div>
            <script>
            document.getElementById('btnIrPergunta').onclick = function() {
                window.location.href = '/pergunta';
            };
            </script>
        </aside>
    </div>
    <script>
    function girarRoleta() {
        const roleta = document.getElementById("roleta");
        const btnGirar = document.getElementById("btnGirar");
        const btnIrPergunta = document.getElementById("btnIrPergunta");
        const temaDiv = document.getElementById("tema-sorteado");
        btnGirar.disabled = true;
        btnGirar.style.opacity = 0.6;
        btnGirar.style.cursor = 'not-allowed';
        btnIrPergunta.disabled = true;
        btnIrPergunta.style.opacity = 0.6;
        btnIrPergunta.style.cursor = 'not-allowed';
        temaDiv.style.opacity = 0;
        // Gira entre 5 e 10 voltas + √¢ngulo aleat√≥rio
        const randomRotation = Math.floor(Math.random() * 360) + 1800;
        roleta.style.transition = "transform 4s cubic-bezier(.17,.67,.83,.67)";
        roleta.style.transform = `rotate(${randomRotation}deg)`;
        setTimeout(() => {
            // Ap√≥s a rota√ß√£o, calcula o tema sorteado
            let rotationDegrees = randomRotation % 360;
            if (rotationDegrees < 0) rotationDegrees += 360;
            const sections = 8;
            const sectionDegree = 360 / sections;
            let winningSection = Math.floor(((360 - rotationDegrees + sectionDegree/2) % 360) / sectionDegree);
            if (winningSection < 0) winningSection = 0;
            if (winningSection > 7) winningSection = 7;
            const boxGanhador = document.getElementById("opt".concat(winningSection));
            temaDiv.innerHTML = boxGanhador ? boxGanhador.innerHTML : 'Erro';
            temaDiv.style.opacity = 1;
            btnIrPergunta.disabled = false;
            btnIrPergunta.style.opacity = 1;
            btnIrPergunta.style.cursor = 'pointer';
            btnGirar.disabled = false;
            btnGirar.style.opacity = 1;
            btnGirar.style.cursor = 'pointer';
        }, 4100);
    }
    
    // Exemplo inicial
    // Carregar equipes reais do backend (GET)
    fetch('/api/estado_jogo')
        .then(response => response.json())
        .then(data => {
            if (data.equipes && data.equipes.length > 0) {
                atualizarPlacar(data.equipes);
            } else {
                // fallback: mostra exemplo
                atualizarPlacar([
                    {nome: 'Equipe Azul', cor: 'azul', pontos: 0},
                    {nome: 'Equipe Laranja', cor: 'laranja', pontos: 0}
                ]);
            }
        })
        .catch(() => {
            atualizarPlacar([
                {nome: 'Equipe Azul', cor: 'azul', pontos: 0},
                {nome: 'Equipe Laranja', cor: 'laranja', pontos: 0}
            ]);
        });
    </script>
</body>
</html>
